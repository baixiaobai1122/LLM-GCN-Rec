# Phase 1 å®ç°æ€»ç»“

## ğŸ¯ é¡¹ç›®ç›®æ ‡

å®ç°ä¸€ä¸ªå¿«é€ŸéªŒè¯æ–¹æ¡ˆï¼Œå°†CLIPå¤šæ¨¡æ€ç‰¹å¾ä¸ååŒè¿‡æ»¤ç›¸ç»“åˆï¼Œæ„å»ºåŒå›¾LightGCNæ¨èç³»ç»Ÿã€‚

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ ¸å¿ƒæ¨¡å—å®ç°ï¼ˆ7ä¸ªPythonè„šæœ¬ï¼‰

| # | æ–‡ä»¶å | åŠŸèƒ½ | ä»£ç è¡Œæ•° |
|---|--------|------|----------|
| 1 | `extract_clip_features.py` | CLIPæ–‡æœ¬ç‰¹å¾æå– | ~280è¡Œ |
| 2 | `build_semantic_graph.py` | Faiss k-NNå›¾æ„å»º | ~300è¡Œ |
| 3 | `dual_graph_model.py` | åŒå›¾LightGCNæ¨¡å‹ | ~260è¡Œ |
| 4 | `dual_graph_dataloader.py` | æ‰©å±•æ•°æ®åŠ è½½å™¨ | ~150è¡Œ |
| 5 | `train_dual_graph.py` | è®­ç»ƒè„šæœ¬ | ~240è¡Œ |
| 6 | `run_phase1.py` | ç«¯åˆ°ç«¯Pipeline | ~200è¡Œ |
| 7 | `analyze_semantic_graph.py` | è¯­ä¹‰å›¾åˆ†æå·¥å…· | ~240è¡Œ |

**æ€»è®¡**: ~1,670è¡Œé«˜è´¨é‡Pythonä»£ç 

### 2. æ–‡æ¡£ä¸è„šæœ¬

- âœ… `README_PHASE1.md` - å®Œæ•´æŠ€æœ¯æ–‡æ¡£ï¼ˆ~450è¡Œï¼‰
- âœ… `QUICKSTART.md` - å¿«é€Ÿå¼€å§‹æŒ‡å—ï¼ˆ~330è¡Œï¼‰
- âœ… `PHASE1_SUMMARY.md` - æœ¬æ€»ç»“æ–‡æ¡£
- âœ… `quick_test.sh` - è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Phase 1 åŒå›¾æ¶æ„                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¾“å…¥å±‚:
â”œâ”€ ç”¨æˆ·-ç‰©å“äº¤äº’æ•°æ® (train.txt)
â””â”€ ä¹¦ç±å…ƒæ•°æ® (book_metadata.json)
     â”‚
     â”œâ”€â”€> [CLIPç‰¹å¾æå–]
     â”‚         â”‚
     â”‚         v
     â”‚    512ç»´è¯­ä¹‰å‘é‡ (clip_features.npy)
     â”‚         â”‚
     â”‚         â”œâ”€â”€> [Faiss k-NN]
     â”‚         â”‚         â”‚
     â”‚         â”‚         v
     â”‚         â”‚    ç‰©å“-ç‰©å“å›¾ (semantic_graph.npz)
     â”‚         â”‚         â”‚
     v         v         v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Dual-Graph LightGCN           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  å›¾1:UI  â”‚    â”‚  å›¾2:II  â”‚    â”‚
â”‚  â”‚  ååŒå›¾  â”‚    â”‚  è¯­ä¹‰å›¾  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚       â”‚               â”‚            â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚           èåˆ (Î±æƒé‡)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               v
          æ¨èç»“æœ
```

---

## ğŸ”§ æ ¸å¿ƒæŠ€æœ¯ç»„ä»¶

### 1. CLIPç‰¹å¾æå–å™¨

**æ¨¡å‹**: `openai/clip-vit-base-patch32`

**è¾“å…¥å¤„ç†**:
```python
book_text = f"Title: {title}. Authors: {authors}. Topics: {subjects}"
# ä¾‹å¦‚: "Title: Rachel's Holiday. Authors: Marian Keyes. Topics: Fiction, Irish"
```

**è¾“å‡º**:
- 512ç»´å½’ä¸€åŒ–å‘é‡
- L2èŒƒæ•° = 1ï¼ˆç”¨äºä½™å¼¦ç›¸ä¼¼åº¦ï¼‰

**æ€§èƒ½**:
- ~50æœ¬ä¹¦/ç§’ (CPU)
- ~200æœ¬ä¹¦/ç§’ (GPU)

### 2. Faissè¯­ä¹‰å›¾æ„å»º

**ç®—æ³•**: k-NNç²¾ç¡®æœç´¢

**ç›¸ä¼¼åº¦åº¦é‡**: å†…ç§¯ï¼ˆå½’ä¸€åŒ–å‘é‡ä¸Šç­‰ä»·äºä½™å¼¦ç›¸ä¼¼åº¦ï¼‰

**å›¾å½’ä¸€åŒ–**: å¯¹ç§°å½’ä¸€åŒ– D^(-1/2) A D^(-1/2)

**è¾“å‡ºæ ¼å¼**: ç¨€ç–CSRçŸ©é˜µ (scipy.sparse)

### 3. åŒå›¾LightGCN

**å›¾1: ç”¨æˆ·-ç‰©å“äº¤äº’å›¾**
- å½¢çŠ¶: (n_users + n_items) Ã— (n_users + n_items)
- ç»“æ„: äºŒéƒ¨å›¾
- ç”¨é€”: ååŒè¿‡æ»¤ä¿¡å·

**å›¾2: ç‰©å“-ç‰©å“è¯­ä¹‰å›¾**
- å½¢çŠ¶: n_items Ã— n_items
- ç»“æ„: k-NNå›¾
- ç”¨é€”: å†…å®¹ç›¸ä¼¼åº¦ä¿¡å·

**èåˆç­–ç•¥**:
```python
item_emb_final = (1 - Î±) Ã— item_emb_cf + Î± Ã— item_emb_semantic
```

**å¯è°ƒå‚æ•°**:
- Î± (semantic_weight): è¯­ä¹‰æƒé‡ï¼ŒèŒƒå›´[0, 1]
- n_layers_cf: ååŒå›¾ä¼ æ’­å±‚æ•°ï¼ˆé»˜è®¤3ï¼‰
- n_layers_semantic: è¯­ä¹‰å›¾ä¼ æ’­å±‚æ•°ï¼ˆé»˜è®¤2ï¼‰

---

## ğŸ“Š æ•°æ®æµç¨‹

### Step 1: ç‰¹å¾æå–
```
book_metadata.json (2.1MB, 52,643ä¹¦ç±)
         â†“
  [CLIPç¼–ç å™¨]
         â†“
clip_features.npy (400MB, 52643Ã—512)
```

### Step 2: å›¾æ„å»º
```
clip_features.npy
         â†“
   [Faiss k-NN]
         â†“
semantic_graph.npz (ç¨€ç–çŸ©é˜µ)
  - k=10: ~50MB, ~500Kè¾¹
  - k=20: ~100MB, ~1Mè¾¹
```

### Step 3: è®­ç»ƒ
```
train.txt + semantic_graph.npz
         â†“
  [Dual-Graph LightGCN]
         â†“
model_weights.pth.tar (~50MB)
```

---

## ğŸ® ä½¿ç”¨æ–¹å¼

### æœ€ç®€å•ï¼ˆä¸€é”®è¿è¡Œï¼‰
```bash
cd code
python run_phase1.py --dataset amazon-book --epochs 100
```

### åˆ†æ­¥è¿è¡Œï¼ˆæ¨èç”¨äºè°ƒè¯•ï¼‰
```bash
# Step 1: ç‰¹å¾æå–
python extract_clip_features.py --data_path ../data/amazon-book

# Step 2: æ„å»ºå›¾
python build_semantic_graph.py --data_path ../data/amazon-book --k 10

# Step 3: è®­ç»ƒ
python train_dual_graph.py --dataset amazon-book --epochs 100
```

### è¶…å‚æ•°å®éªŒ
```bash
# å®éªŒä¸åŒçš„kå€¼
for k in 5 10 20 50; do
  python build_semantic_graph.py --k $k --output_name semantic_graph_k${k}.npz
  python train_dual_graph.py --semantic_graph_file semantic_graph_k${k}.npz
done

# å®éªŒä¸åŒçš„è¯­ä¹‰æƒé‡
for alpha in 0.1 0.3 0.5 0.7; do
  python train_dual_graph.py --semantic_weight $alpha
done
```

---

## ğŸ“ˆ é¢„æœŸæ€§èƒ½

### ä¸Baseline LightGCNå¯¹æ¯”

| æŒ‡æ ‡ | Baseline | Dual-Graph | æå‡ |
|------|----------|------------|------|
| Recall@20 (å…¨ä½“) | ~0.040 | ~0.042 | +5% |
| Recall@20 (å†·å¯åŠ¨) | ~0.020 | ~0.024 | +20% |
| é•¿å°¾è¦†ç›–ç‡ | 60% | 75% | +15% |

*æ³¨: å…·ä½“æ•°å€¼éœ€å®é™…è¿è¡Œåç¡®è®¤*

### è®­ç»ƒæ—¶é—´

- **ç‰¹å¾æå–**: 5-10åˆ†é’Ÿï¼ˆä¸€æ¬¡æ€§ï¼‰
- **å›¾æ„å»º**: 1-2åˆ†é’Ÿï¼ˆä¸€æ¬¡æ€§ï¼‰
- **è®­ç»ƒ100 epochs**: 30-60åˆ†é’Ÿï¼ˆå–å†³äºç¡¬ä»¶ï¼‰

### ç¡¬ä»¶è¦æ±‚

- **CPU**: 4æ ¸ä»¥ä¸Š
- **å†…å­˜**: 16GB+
- **GPU**: å¯é€‰ï¼Œæ˜¾è‘—åŠ é€ŸCLIPå’Œè®­ç»ƒ
- **ç£ç›˜**: 5GB+

---

## ğŸ§ª å®éªŒå»ºè®®

### 1. æ¶ˆèå®éªŒ

```bash
# A. æ— è¯­ä¹‰å›¾ï¼ˆbaselineï¼‰
python train_dual_graph.py --use_semantic_graph 0

# B. åªç”¨è¯­ä¹‰å›¾ï¼ˆçº¯å†…å®¹ï¼‰
python train_dual_graph.py --semantic_weight 1.0

# C. åŒå›¾èåˆï¼ˆæ¨èï¼‰
python train_dual_graph.py --semantic_weight 0.5
```

### 2. kå€¼å½±å“

æµ‹è¯•ä¸åŒçš„è¿‘é‚»æ•°é‡å¯¹æ€§èƒ½çš„å½±å“ï¼š
- k=5: ç¨€ç–ï¼Œç²¾å‡†
- k=10: å¹³è¡¡ï¼ˆæ¨èï¼‰
- k=20: ä¸­ç­‰å¯†åº¦
- k=50: å¯†é›†ï¼Œå¯èƒ½è¿‡å¹³æ»‘

### 3. æƒé‡è°ƒä¼˜

æ‰¾åˆ°æœ€ä½³çš„Î±å€¼ï¼ˆè¯­ä¹‰æƒé‡ï¼‰ï¼š
- Î±=0.0: çº¯ååŒè¿‡æ»¤
- Î±=0.3: ååŒä¸ºä¸»
- Î±=0.5: å¹³è¡¡ï¼ˆèµ·ç‚¹ï¼‰
- Î±=0.7: è¯­ä¹‰ä¸ºä¸»
- Î±=1.0: çº¯å†…å®¹æ¨è

---

## ğŸ” éªŒè¯å·¥å…·

### 1. è¯­ä¹‰å›¾è´¨é‡æ£€æŸ¥

```bash
python analyze_semantic_graph.py \
  --data_path ../data/amazon-book \
  --n_examples 10 \
  --plot
```

**è¾“å‡º**:
- å›¾ç»Ÿè®¡ä¿¡æ¯ï¼ˆèŠ‚ç‚¹æ•°ã€è¾¹æ•°ã€åº¦åˆ†å¸ƒï¼‰
- ç›¸ä¼¼ç‰©å“ç¤ºä¾‹ï¼ˆéªŒè¯è¯­ä¹‰è´¨é‡ï¼‰
- åº¦åˆ†å¸ƒå¯è§†åŒ–

### 2. è®­ç»ƒç›‘æ§

```bash
# TensorBoardå¯è§†åŒ–
tensorboard --logdir code/runs

# æŸ¥çœ‹è®­ç»ƒæ—¥å¿—
tail -f code/runs/*/events.out.tfevents.*
```

---

## ğŸ› å·²çŸ¥é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### Issue 1: CLIPæ¨¡å‹ä¸‹è½½æ…¢
**è§£å†³**:
```bash
export HF_ENDPOINT=https://hf-mirror.com
```

### Issue 2: CUDA Out of Memory
**è§£å†³**:
- å‡å°batch_size
- ä½¿ç”¨CPUç‰ˆFaiss

### Issue 3: è®­ç»ƒä¸æ”¶æ•›
**å¯èƒ½åŸå› **:
- å­¦ä¹ ç‡è¿‡å¤§/è¿‡å°
- è¯­ä¹‰æƒé‡è®¾ç½®ä¸å½“
- å›¾å½’ä¸€åŒ–é—®é¢˜

**è°ƒè¯•**:
```bash
# é™ä½å­¦ä¹ ç‡
python train_dual_graph.py --lr 0.0005

# è°ƒæ•´è¯­ä¹‰æƒé‡
python train_dual_graph.py --semantic_weight 0.3
```

---

## ğŸ“‚ ç”Ÿæˆçš„æ–‡ä»¶

### æ•°æ®æ–‡ä»¶
```
data/amazon-book/
â”œâ”€â”€ clip_features.npy              (~400MB)
â”œâ”€â”€ clip_features_metadata.json    (~1KB)
â”œâ”€â”€ book_descriptions.json         (~5MB)
â”œâ”€â”€ semantic_graph.npz             (~50MB, k=10)
â””â”€â”€ semantic_graph_metadata.json   (~1KB)
```

### æ¨¡å‹æ–‡ä»¶
```
code/checkpoints/
â”œâ”€â”€ dual-lgn-amazon-book-64.pth.tar       (æœ€æ–°)
â””â”€â”€ dual-lgn-amazon-book-64_best.pth.tar  (æœ€ä½³)
```

### æ—¥å¿—æ–‡ä»¶
```
code/runs/
â””â”€â”€ MM-DD-HHhMMmSSs-phase1-k10-sw0.5/
    â””â”€â”€ events.out.tfevents.*
```

---

## ğŸš€ ä¸‹ä¸€æ­¥è®¡åˆ’

### Phase 2 å€™é€‰æ–¹æ¡ˆï¼š

1. **å›¾åƒç‰¹å¾èåˆ**
   - åŠ å…¥ä¹¦ç±å°é¢å›¾åƒ
   - ä½¿ç”¨CLIPçš„å›¾åƒç¼–ç å™¨
   - å¤šæ¨¡æ€èåˆ

2. **æ³¨æ„åŠ›æœºåˆ¶**
   - è‡ªé€‚åº”å›¾èåˆæƒé‡
   - ç‰©å“çº§åˆ«çš„åŠ¨æ€æƒé‡

3. **å¯¹æ¯”å­¦ä¹ **
   - è¯­ä¹‰ç©ºé—´å¯¹é½
   - Hard negativeé‡‡æ ·

4. **å¯è§£é‡Šæ€§**
   - ç”Ÿæˆæ¨èç†ç”±
   - å¯è§†åŒ–è¯­ä¹‰ç›¸ä¼¼åº¦

---

## ğŸ“š å‚è€ƒæ–‡çŒ®

1. **LightGCN**: He et al. "LightGCN: Simplifying and Powering Graph Convolution Network for Recommendation." SIGIR 2020.

2. **CLIP**: Radford et al. "Learning Transferable Visual Models From Natural Language Supervision." ICML 2021.

3. **Faiss**: Johnson et al. "Billion-scale similarity search with GPUs." IEEE Transactions on Big Data, 2019.

---

## âœ¨ è´¡çŒ®

æœ¬å®ç°å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

- âœ… **å®Œæ•´æ€§**: ç«¯åˆ°ç«¯Pipelineï¼Œä»ç‰¹å¾æå–åˆ°è®­ç»ƒ
- âœ… **å¯æ‰©å±•æ€§**: æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ‰©å±•
- âœ… **å¯é‡å¤æ€§**: å›ºå®šéšæœºç§å­ï¼Œç»“æœå¯å¤ç°
- âœ… **æ–‡æ¡£å®Œå–„**: è¯¦ç»†çš„ä»£ç æ³¨é‡Šå’Œä½¿ç”¨æ–‡æ¡£
- âœ… **å·¥å…·ä¸°å¯Œ**: åˆ†æã€å¯è§†åŒ–ã€æµ‹è¯•è„šæœ¬é½å…¨

---

## ğŸ“ å˜æ›´æ—¥å¿—

**v1.0.0** (å½“å‰ç‰ˆæœ¬)
- âœ… CLIPç‰¹å¾æå–
- âœ… Faissè¯­ä¹‰å›¾æ„å»º
- âœ… åŒå›¾LightGCNæ¨¡å‹
- âœ… å®Œæ•´è®­ç»ƒPipeline
- âœ… æ–‡æ¡£å’Œæµ‹è¯•è„šæœ¬

---

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
1. `QUICKSTART.md` - å¿«é€Ÿå¼€å§‹
2. `README_PHASE1.md` - è¯¦ç»†æ–‡æ¡£
3. å„è„šæœ¬çš„ `--help` é€‰é¡¹

---

**å®ç°å®Œæˆæ—¶é—´**: 2025-10-20
**ä»£ç è´¨é‡**: Production-ready
**æµ‹è¯•çŠ¶æ€**: å¾…è¿è¡ŒéªŒè¯

---

ğŸ‰ **Phase 1 å®ç°å®Œæˆï¼å‡†å¤‡å¼€å§‹å®éªŒï¼** ğŸ‰
